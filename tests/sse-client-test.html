<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SSE Progress Tracking Test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .progress-item {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            padding: 15px;
            margin: 10px 0;
        }
        .progress-bar {
            background-color: #e9ecef;
            border-radius: 4px;
            overflow: hidden;
            height: 20px;
            margin: 10px 0;
        }
        .progress-fill {
            background-color: #007bff;
            height: 100%;
            transition: width 0.3s ease;
            text-align: center;
            color: white;
            line-height: 20px;
            font-size: 12px;
        }
        .status {
            font-weight: bold;
            margin: 5px 0;
        }
        .status.running { color: #007bff; }
        .status.completed { color: #28a745; }
        .status.error { color: #dc3545; }
        .controls {
            margin: 20px 0;
        }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background: #0056b3;
        }
        button:disabled {
            background: #6c757d;
            cursor: not-allowed;
        }
        .log {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            padding: 10px;
            margin: 10px 0;
            max-height: 300px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 12px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>🚀 SSE Progress Tracking Test</h1>
        
        <div class="controls">
            <button id="connectBtn" onclick="connect()">연결</button>
            <button id="disconnectBtn" onclick="disconnect()" disabled>연결 해제</button>
            <button id="clearBtn" onclick="clearLog()">로그 지우기</button>
        </div>

        <div class="controls">
            <button onclick="testSearch()">검색 테스트</button>
            <button onclick="testList()">목록 테스트</button>
            <button onclick="testBatch()">배치 테스트</button>
        </div>

        <div id="connectionStatus">연결 대기 중...</div>

        <div id="progressContainer"></div>

        <div class="log" id="log"></div>
    </div>

    <script>
        let eventSource = null;
        let isConnected = false;

        function log(message) {
            const logElement = document.getElementById('log');
            const time = new Date().toLocaleTimeString();
            logElement.innerHTML += `[${time}] ${message}\n`;
            logElement.scrollTop = logElement.scrollHeight;
        }

        function updateConnectionStatus(status) {
            document.getElementById('connectionStatus').textContent = status;
        }

        function connect() {
            if (isConnected) return;

            try {
                eventSource = new EventSource('http://localhost:3001/sse');
                
                eventSource.onopen = function(event) {
                    isConnected = true;
                    updateConnectionStatus('✅ 연결됨');
                    document.getElementById('connectBtn').disabled = true;
                    document.getElementById('disconnectBtn').disabled = false;
                    log('SSE 연결이 성공했습니다.');
                };

                eventSource.onmessage = function(event) {
                    log(`메시지 수신: ${event.data}`);
                };

                eventSource.addEventListener('progress', function(event) {
                    const data = JSON.parse(event.data);
                    updateProgress(data);
                    log(`진행상황 업데이트: ${JSON.stringify(data)}`);
                });

                eventSource.addEventListener('task-start', function(event) {
                    const data = JSON.parse(event.data);
                    createProgressItem(data);
                    log(`작업 시작: ${data.taskId}`);
                });

                eventSource.addEventListener('task-complete', function(event) {
                    const data = JSON.parse(event.data);
                    completeProgressItem(data);
                    log(`작업 완료: ${data.taskId}`);
                });

                eventSource.addEventListener('task-error', function(event) {
                    const data = JSON.parse(event.data);
                    errorProgressItem(data);
                    log(`작업 오류: ${data.taskId} - ${data.error}`);
                });

                eventSource.onerror = function(event) {
                    log('SSE 연결 오류가 발생했습니다.');
                    if (isConnected) {
                        disconnect();
                    }
                };

            } catch (error) {
                log(`연결 오류: ${error.message}`);
            }
        }

        function disconnect() {
            if (eventSource) {
                eventSource.close();
                eventSource = null;
            }
            isConnected = false;
            updateConnectionStatus('❌ 연결 해제됨');
            document.getElementById('connectBtn').disabled = false;
            document.getElementById('disconnectBtn').disabled = true;
            log('SSE 연결이 해제되었습니다.');
        }

        function clearLog() {
            document.getElementById('log').innerHTML = '';
        }

        function createProgressItem(data) {
            const container = document.getElementById('progressContainer');
            const item = document.createElement('div');
            item.className = 'progress-item';
            item.id = `progress-${data.taskId}`;
            
            item.innerHTML = `
                <div><strong>작업 ID:</strong> ${data.taskId}</div>
                <div><strong>작업 유형:</strong> ${data.operation || 'Unknown'}</div>
                <div class="status running">상태: 진행 중</div>
                <div class="progress-bar">
                    <div class="progress-fill" style="width: 0%">0%</div>
                </div>
                <div>처리된 항목: <span class="processed">0</span> / <span class="total">?</span></div>
            `;
            
            container.appendChild(item);
        }

        function updateProgress(data) {
            const item = document.getElementById(`progress-${data.taskId}`);
            if (!item) return;

            const progressFill = item.querySelector('.progress-fill');
            const processedSpan = item.querySelector('.processed');
            const totalSpan = item.querySelector('.total');

            if (data.progress !== undefined) {
                const percentage = Math.round(data.progress);
                progressFill.style.width = `${percentage}%`;
                progressFill.textContent = `${percentage}%`;
            }

            if (data.processed !== undefined) {
                processedSpan.textContent = data.processed;
            }

            if (data.total !== undefined) {
                totalSpan.textContent = data.total;
            }
        }

        function completeProgressItem(data) {
            const item = document.getElementById(`progress-${data.taskId}`);
            if (!item) return;

            const status = item.querySelector('.status');
            status.textContent = '상태: 완료';
            status.className = 'status completed';

            const progressFill = item.querySelector('.progress-fill');
            progressFill.style.width = '100%';
            progressFill.textContent = '100%';
            progressFill.style.backgroundColor = '#28a745';
        }

        function errorProgressItem(data) {
            const item = document.getElementById(`progress-${data.taskId}`);
            if (!item) return;

            const status = item.querySelector('.status');
            status.textContent = `상태: 오류 - ${data.error}`;
            status.className = 'status error';

            const progressFill = item.querySelector('.progress-fill');
            progressFill.style.backgroundColor = '#dc3545';
        }

        // 테스트 함수들
        async function testSearch() {
            try {
                const response = await fetch('http://localhost:3001/api/test/search', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        query: 'test',
                        includeProgress: true
                    })
                });
                const result = await response.json();
                log(`검색 테스트 요청 완료: ${JSON.stringify(result)}`);
            } catch (error) {
                log(`검색 테스트 오류: ${error.message}`);
            }
        }

        async function testList() {
            try {
                const response = await fetch('http://localhost:3001/api/test/list', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        limit: 100,
                        includeProgress: true
                    })
                });
                const result = await response.json();
                log(`목록 테스트 요청 완료: ${JSON.stringify(result)}`);
            } catch (error) {
                log(`목록 테스트 오류: ${error.message}`);
            }
        }

        async function testBatch() {
            try {
                const response = await fetch('http://localhost:3001/api/test/batch', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        operations: [
                            { type: 'add', data: { content: 'Test batch 1' } },
                            { type: 'add', data: { content: 'Test batch 2' } },
                            { type: 'add', data: { content: 'Test batch 3' } }
                        ],
                        includeProgress: true
                    })
                });
                const result = await response.json();
                log(`배치 테스트 요청 완료: ${JSON.stringify(result)}`);
            } catch (error) {
                log(`배치 테스트 오류: ${error.message}`);
            }
        }

        // 페이지 로드 시 자동 연결 시도
        window.addEventListener('load', function() {
            log('페이지가 로드되었습니다. 연결 버튼을 클릭하여 시작하세요.');
        });

        // 페이지 종료 시 연결 해제
        window.addEventListener('beforeunload', function() {
            if (isConnected) {
                disconnect();
            }
        });
    </script>
</body>
</html>