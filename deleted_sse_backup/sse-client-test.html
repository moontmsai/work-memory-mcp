<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SSE Progress Tracking Test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .progress-item {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            padding: 15px;
            margin: 10px 0;
        }
        .progress-bar {
            background-color: #e9ecef;
            border-radius: 4px;
            overflow: hidden;
            height: 20px;
            margin: 10px 0;
        }
        .progress-fill {
            background-color: #007bff;
            height: 100%;
            transition: width 0.3s ease;
            text-align: center;
            color: white;
            line-height: 20px;
            font-size: 12px;
        }
        .status {
            font-weight: bold;
            margin: 5px 0;
        }
        .status.running { color: #007bff; }
        .status.completed { color: #28a745; }
        .status.error { color: #dc3545; }
        .controls {
            margin: 20px 0;
        }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background: #0056b3;
        }
        button:disabled {
            background: #6c757d;
            cursor: not-allowed;
        }
        .log {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            padding: 10px;
            margin: 10px 0;
            max-height: 300px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 12px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸš€ SSE Progress Tracking Test</h1>
        
        <div class="controls">
            <button id="connectBtn" onclick="connect()">ì—°ê²°</button>
            <button id="disconnectBtn" onclick="disconnect()" disabled>ì—°ê²° í•´ì œ</button>
            <button id="clearBtn" onclick="clearLog()">ë¡œê·¸ ì§€ìš°ê¸°</button>
        </div>

        <div class="controls">
            <button onclick="testSearch()">ê²€ìƒ‰ í…ŒìŠ¤íŠ¸</button>
            <button onclick="testList()">ëª©ë¡ í…ŒìŠ¤íŠ¸</button>
            <button onclick="testBatch()">ë°°ì¹˜ í…ŒìŠ¤íŠ¸</button>
        </div>

        <div id="connectionStatus">ì—°ê²° ëŒ€ê¸° ì¤‘...</div>

        <div id="progressContainer"></div>

        <div class="log" id="log"></div>
    </div>

    <script>
        let eventSource = null;
        let isConnected = false;

        function log(message) {
            const logElement = document.getElementById('log');
            const time = new Date().toLocaleTimeString();
            logElement.innerHTML += `[${time}] ${message}\n`;
            logElement.scrollTop = logElement.scrollHeight;
        }

        function updateConnectionStatus(status) {
            document.getElementById('connectionStatus').textContent = status;
        }

        function connect() {
            if (isConnected) return;

            try {
                eventSource = new EventSource('http://localhost:3001/sse');
                
                eventSource.onopen = function(event) {
                    isConnected = true;
                    updateConnectionStatus('âœ… ì—°ê²°ë¨');
                    document.getElementById('connectBtn').disabled = true;
                    document.getElementById('disconnectBtn').disabled = false;
                    log('SSE ì—°ê²°ì´ ì„±ê³µí–ˆìŠµë‹ˆë‹¤.');
                };

                eventSource.onmessage = function(event) {
                    log(`ë©”ì‹œì§€ ìˆ˜ì‹ : ${event.data}`);
                };

                eventSource.addEventListener('progress', function(event) {
                    const data = JSON.parse(event.data);
                    updateProgress(data);
                    log(`ì§„í–‰ìƒí™© ì—…ë°ì´íŠ¸: ${JSON.stringify(data)}`);
                });

                eventSource.addEventListener('task-start', function(event) {
                    const data = JSON.parse(event.data);
                    createProgressItem(data);
                    log(`ì‘ì—… ì‹œì‘: ${data.taskId}`);
                });

                eventSource.addEventListener('task-complete', function(event) {
                    const data = JSON.parse(event.data);
                    completeProgressItem(data);
                    log(`ì‘ì—… ì™„ë£Œ: ${data.taskId}`);
                });

                eventSource.addEventListener('task-error', function(event) {
                    const data = JSON.parse(event.data);
                    errorProgressItem(data);
                    log(`ì‘ì—… ì˜¤ë¥˜: ${data.taskId} - ${data.error}`);
                });

                eventSource.onerror = function(event) {
                    log('SSE ì—°ê²° ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
                    if (isConnected) {
                        disconnect();
                    }
                };

            } catch (error) {
                log(`ì—°ê²° ì˜¤ë¥˜: ${error.message}`);
            }
        }

        function disconnect() {
            if (eventSource) {
                eventSource.close();
                eventSource = null;
            }
            isConnected = false;
            updateConnectionStatus('âŒ ì—°ê²° í•´ì œë¨');
            document.getElementById('connectBtn').disabled = false;
            document.getElementById('disconnectBtn').disabled = true;
            log('SSE ì—°ê²°ì´ í•´ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
        }

        function clearLog() {
            document.getElementById('log').innerHTML = '';
        }

        function createProgressItem(data) {
            const container = document.getElementById('progressContainer');
            const item = document.createElement('div');
            item.className = 'progress-item';
            item.id = `progress-${data.taskId}`;
            
            item.innerHTML = `
                <div><strong>ì‘ì—… ID:</strong> ${data.taskId}</div>
                <div><strong>ì‘ì—… ìœ í˜•:</strong> ${data.operation || 'Unknown'}</div>
                <div class="status running">ìƒíƒœ: ì§„í–‰ ì¤‘</div>
                <div class="progress-bar">
                    <div class="progress-fill" style="width: 0%">0%</div>
                </div>
                <div>ì²˜ë¦¬ëœ í•­ëª©: <span class="processed">0</span> / <span class="total">?</span></div>
            `;
            
            container.appendChild(item);
        }

        function updateProgress(data) {
            const item = document.getElementById(`progress-${data.taskId}`);
            if (!item) return;

            const progressFill = item.querySelector('.progress-fill');
            const processedSpan = item.querySelector('.processed');
            const totalSpan = item.querySelector('.total');

            if (data.progress !== undefined) {
                const percentage = Math.round(data.progress);
                progressFill.style.width = `${percentage}%`;
                progressFill.textContent = `${percentage}%`;
            }

            if (data.processed !== undefined) {
                processedSpan.textContent = data.processed;
            }

            if (data.total !== undefined) {
                totalSpan.textContent = data.total;
            }
        }

        function completeProgressItem(data) {
            const item = document.getElementById(`progress-${data.taskId}`);
            if (!item) return;

            const status = item.querySelector('.status');
            status.textContent = 'ìƒíƒœ: ì™„ë£Œ';
            status.className = 'status completed';

            const progressFill = item.querySelector('.progress-fill');
            progressFill.style.width = '100%';
            progressFill.textContent = '100%';
            progressFill.style.backgroundColor = '#28a745';
        }

        function errorProgressItem(data) {
            const item = document.getElementById(`progress-${data.taskId}`);
            if (!item) return;

            const status = item.querySelector('.status');
            status.textContent = `ìƒíƒœ: ì˜¤ë¥˜ - ${data.error}`;
            status.className = 'status error';

            const progressFill = item.querySelector('.progress-fill');
            progressFill.style.backgroundColor = '#dc3545';
        }

        // í…ŒìŠ¤íŠ¸ í•¨ìˆ˜ë“¤
        async function testSearch() {
            try {
                const response = await fetch('http://localhost:3001/api/test/search', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        query: 'test',
                        includeProgress: true
                    })
                });
                const result = await response.json();
                log(`ê²€ìƒ‰ í…ŒìŠ¤íŠ¸ ìš”ì²­ ì™„ë£Œ: ${JSON.stringify(result)}`);
            } catch (error) {
                log(`ê²€ìƒ‰ í…ŒìŠ¤íŠ¸ ì˜¤ë¥˜: ${error.message}`);
            }
        }

        async function testList() {
            try {
                const response = await fetch('http://localhost:3001/api/test/list', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        limit: 100,
                        includeProgress: true
                    })
                });
                const result = await response.json();
                log(`ëª©ë¡ í…ŒìŠ¤íŠ¸ ìš”ì²­ ì™„ë£Œ: ${JSON.stringify(result)}`);
            } catch (error) {
                log(`ëª©ë¡ í…ŒìŠ¤íŠ¸ ì˜¤ë¥˜: ${error.message}`);
            }
        }

        async function testBatch() {
            try {
                const response = await fetch('http://localhost:3001/api/test/batch', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        operations: [
                            { type: 'add', data: { content: 'Test batch 1' } },
                            { type: 'add', data: { content: 'Test batch 2' } },
                            { type: 'add', data: { content: 'Test batch 3' } }
                        ],
                        includeProgress: true
                    })
                });
                const result = await response.json();
                log(`ë°°ì¹˜ í…ŒìŠ¤íŠ¸ ìš”ì²­ ì™„ë£Œ: ${JSON.stringify(result)}`);
            } catch (error) {
                log(`ë°°ì¹˜ í…ŒìŠ¤íŠ¸ ì˜¤ë¥˜: ${error.message}`);
            }
        }

        // í˜ì´ì§€ ë¡œë“œ ì‹œ ìë™ ì—°ê²° ì‹œë„
        window.addEventListener('load', function() {
            log('í˜ì´ì§€ê°€ ë¡œë“œë˜ì—ˆìŠµë‹ˆë‹¤. ì—°ê²° ë²„íŠ¼ì„ í´ë¦­í•˜ì—¬ ì‹œì‘í•˜ì„¸ìš”.');
        });

        // í˜ì´ì§€ ì¢…ë£Œ ì‹œ ì—°ê²° í•´ì œ
        window.addEventListener('beforeunload', function() {
            if (isConnected) {
                disconnect();
            }
        });
    </script>
</body>
</html>